# Created with podman-3.4.4
---
apiVersion: v1
kind: Pod
metadata:
  name: pihole-annotations
  annotations:
    bind-mount-options: "/home/{{ user_name }}/pihole/etc-dnsmasq.d: Z"
    bind-mount-options: "/home/{{ user_name }}/pihole/etc-pihole: Z"
    bind-mount-options: "/home/{{ user_name }}/pihole/etc-unbound: Z"
  labels:
    app: pihole
  name: pihole
spec:
  volumes:
  - name: etc-pihole
    hostPath:
      path: /home/{{ user_name }}/pihole/etc-pihole
      type: Directory

  - name: etc-lighttpd-external.conf
    hostPath:
      path: /home/{{ user_name }}/pihole/etc-lighttpd/external.conf
      type: File

  - name: etc-lighttpd-cert_privkey_combined.pem
    hostPath:
      path: /home/{{ user_name }}/pihole/etc-lighttpd/cert_privkey_combined.pem
      type: File

  - name: etc-dnsmasq.d
    hostPath:
      path: /home/{{ user_name }}/pihole/etc-dnsmasq.d
      type: Directory

  - name: etc-unbound
    hostPath:
      path: /home/{{ user_name }}/pihole/etc-unbound
      type: Directory

  containers:
  - image: docker.io/mvance/unbound-rpi:latest
    name: unbound

    env:
    - name: TZ
      value: "America/Chicago"

    ports:
    - containerPort: 5353
      hostPort: 5353

    - containerPort: 5353
      hostPort: 5353
      protocol: UDP

    securityContext:
      capabilities:
        drop:
        - CAP_MKNOD
        - CAP_NET_RAW
        - CAP_AUDIT_WRITE

    dnsConfig:
      nameservers:
        - {{ dns_server1 }}
        - {{ dns_server2 }}

    volumeMounts:
    - name: etc-unbound
      mountPath: /opt/unbound/etc/unbound/

  - image: docker.io/pihole/pihole:latest
    name: pihole

    env:
    - name: TZ
      value: "America/Chicago"

    - name: WEBPASSWORD
      value: "{{ web_password }}"

    ports:
    - containerPort: 53
      hostPort: 53

    - containerPort: 53
      hostPort: 53
      protocol: UDP

    - containerPort: 443
      hostPort: 10002

    - containerPort: 80
      hostPort: 10003

    securityContext:
      capabilities:
        drop:
        - CAP_MKNOD
        - CAP_NET_RAW
        - CAP_AUDIT_WRITE

    dnsConfig:
      nameservers:
        - 127.0.0.1

    volumeMounts:
    - name: etc-pihole
      mountPath: /etc/pihole

    - name: etc-lighttpd-external.conf
      mountPath: /etc/lighttpd/external.conf:Z

    - name: etc-lighttpd-cert_privkey_combined.pem
      mountPath: /etc/lighttpd/cert_privkey_combined.pem:Z

    - name: etc-dnsmasq.d
      mountPath: /etc/dnsmasq.d/:Z
