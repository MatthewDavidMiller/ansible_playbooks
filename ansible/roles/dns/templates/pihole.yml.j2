# Created with podman-3.4.4
---
apiVersion: v1
kind: Pod
metadata:
  annotations:
    bind-mount-options:/home/{{ user_name }}/pihole/etc-dnsmasq.d: Z
    bind-mount-options:/home/{{ user_name }}/pihole/etc-pihole: Z
    bind-mount-options:/home/{{ user_name }}/pihole/etc-unbound: Z
  labels:
    app: pihole
  name: pihole
spec:
  containers:
  - image: docker.io/mvance/unbound-rpi:latest
    name: unbound
    env:
    - name: TZ
      value: "America/Chicago"
    ports:
    - containerPort: 5353
      hostPort: 5353
    - containerPort: 5353
      hostPort: 5353
      protocol: UDP
    securityContext:
      capabilities:
        drop:
        - CAP_MKNOD
        - CAP_NET_RAW
        - CAP_AUDIT_WRITE
    volumeMounts:
    - mountPath: /opt/unbound/etc/unbound/
      name: home-{{ user_name }}-pihole-etc-unbound-host-0
  dnsConfig:
    nameservers:
    - {{ dns_server1 }}
    - {{ dns_server2 }}
  volumes:
  - hostPath:
      path: /home/{{ user_name }}/pihole/etc-unbound
      type: Directory
    name: home-{{ user_name }}-pihole-etc-unbound-host-0

  - image: docker.io/pihole/pihole:latest
    name: pihole
    env:
    - name: TZ
      value: "America/Chicago"
    - name: WEBPASSWORD
      value: "{{ web_password }}"
    ports:
    - containerPort: 53
      hostPort: 53
    - containerPort: 53
      hostPort: 53
      protocol: UDP
    - containerPort: 443
      hostPort: 10002
    - containerPort: 80
      hostPort: 10003
    securityContext:
      capabilities:
        drop:
        - CAP_MKNOD
        - CAP_NET_RAW
        - CAP_AUDIT_WRITE
    volumeMounts:
    - mountPath: /etc/pihole
      name: home-{{ user_name }}-pihole-etc-pihole-host-0
    - mountPath: /etc/lighttpd/external.conf:Z
      name: home-{{ user_name }}-pihole-etc-lighttpd-external.conf-host-1
    - mountPath: /etc/lighttpd/cert_privkey_combined.pem:Z
      name: home-{{ user_name }}-pihole-etc-lighttpd-cert_privkey_combined.pem-host-2
    - mountPath: /etc/dnsmasq.d/
      name: home-{{ user_name }}-pihole-etc-dnsmasq.d-host-3
  dnsConfig:
    nameservers:
    - localhost
  volumes:
  - hostPath:
      path: /home/{{ user_name }}/pihole/etc-pihole
      type: Directory
    name: home-{{ user_name }}-pihole-etc-pihole-host-0
  - hostPath:
      path: /home/{{ user_name }}/pihole/etc-lighttpd/external.conf
      type: File
    name: home-{{ user_name }}-pihole-etc-lighttpd-external.conf-host-1
  - hostPath:
      path: /home/{{ user_name }}/pihole/etc-lighttpd/cert_privkey_combined.pem
      type: File
    name: home-{{ user_name }}-pihole-etc-lighttpd-cert_privkey_combined.pem-host-2
  - hostPath:
      path: /home/{{ user_name }}/pihole/etc-dnsmasq.d
      type: Directory
    name: home-{{ user_name }}-pihole-etc-dnsmasq.d-host-3
