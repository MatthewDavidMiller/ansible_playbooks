#!/bin/bash

# === Configuration ===
NEXTCLOUD_BORG_REMOTE="Nextcloud:{{ nextcloud_paperless_backup_location }}"
BORG_REPO="{{ nextcloud_borg_backup_path }}"
timestamp=$(date +%Y_%m_%d)
EXPORT_DIR="{{ paperless_export_path }}/${timestamp}"
CONTAINER_EXPORT_DIR="/usr/src/paperless/export/${timestamp}"

# === Truncate Logs ===
/usr/bin/truncate -s 0 /var/log/borg-backup.log
/usr/bin/truncate -s 0 /var/log/borg-prune.log
/usr/bin/truncate -s 0 /var/log/rclone-nextcloud-borg.log

# === Create Borg Repository Directory ===
# Check if directory exists to ensure idempotency before creating
if [ ! -d "$BORG_REPO" ]; then
    /usr/bin/mkdir -p "$BORG_REPO" || {
        echo "Failed to create Borg repository directory: $BORG_REPO" >&2
        exit 1
    }
fi

# === Ensure Borg is initialized ===
if [ ! -d "$BORG_REPO" ]; then
    /usr/bin/borg init --encryption=none "$BORG_REPO" > /var/log/borg-backup.log 2>&1
fi

# === Dump Paperless DB ===
# Note: May produce collation mismatch warning due to host OS having newer glibc than container.
# To verify collation: podman exec postgres psql -U {{ paperless_database_user }} {{ paperless_database_name }} -c "SHOW LC_COLLATE;"
/usr/bin/podman exec postgres pg_dump -U {{ paperless_database_user }} {{ paperless_database_name }} \
  > "/paperless_db_${timestamp}.sql"

# === Dump Nextcloud DB ===
# Note: May produce collation mismatch warning due to host OS having newer glibc than container.
# To verify collation: podman exec postgres psql -U {{ nextcloud_database_user }} {{ nextcloud_database_name }} -c "SHOW LC_COLLATE;"
/usr/bin/podman exec postgres pg_dump -U {{ nextcloud_database_user }} {{ nextcloud_database_name }} \
  > "/nextcloud_db_${timestamp}.sql"

# === Create Export Directory for Paperless Documents ===
# Check if directory exists to ensure idempotency before creating
# Ensure {{ paperless_export_path }} is mounted to /usr/src/paperless/export in the paperless container (e.g., -v {{ paperless_export_path }}:/usr/src/paperless/export)
# Verify with: podman inspect paperless | grep -i mount
if [ ! -d "$EXPORT_DIR" ]; then
    /usr/bin/mkdir -p "$EXPORT_DIR" || {
        echo "Failed to create export directory: $EXPORT_DIR" >&2
        exit 1
    }
fi

# === Export Paperless Documents ===
/usr/bin/podman exec paperless document_exporter "$CONTAINER_EXPORT_DIR" || {
    echo "Paperless document export failed for directory: $CONTAINER_EXPORT_DIR" >&2
    exit 1
}

# === Borg Backup for Paperless and Nextcloud (Documents + DBs) ===
/usr/bin/borg create "$BORG_REPO::backup-${timestamp}" \
    "$EXPORT_DIR" \
    "/paperless_db_${timestamp}.sql" \
    "/nextcloud_db_${timestamp}.sql" \
    --compression=lz4 \
    > /var/log/borg-backup.log 2>&1

# === Prune Borg Backups (Keep 30 days) ===
/usr/bin/borg prune --keep-daily=30 "$BORG_REPO" \
    > /var/log/borg-prune.log 2>&1

# === Rclone Borg Repo to Nextcloud ===
/usr/bin/rclone sync "$BORG_REPO" "${NEXTCLOUD_BORG_REMOTE}" \
    --log-level INFO --log-file=/var/log/rclone-nextcloud-borg.log

# === Cleanup ===
if [ $? -eq 0 ]; then
    /usr/bin/rm -rf "$EXPORT_DIR"
    /usr/bin/rm "/paperless_db_${timestamp}.sql"
    /usr/bin/rm "/nextcloud_db_${timestamp}.sql"
else
    echo "Backup or upload failed. Temporary files retained." >&2
    exit 1
fi
