# Created with podman-3.4.4
---
apiVersion: v1
kind: Pod
metadata:
  annotations:
    bind-mount-options:/home/{{ user_name }}/nextcloud/apps: Z
    bind-mount-options:/home/{{ user_name }}/nextcloud/base: Z
    bind-mount-options:/home/{{ user_name }}/nextcloud/config: Z
    bind-mount-options:/home/{{ user_name }}/nextcloud/data: Z
    bind-mount-options:/home/{{ user_name }}/postgres: Z
  labels:
    app: nextcloud
  name: nextcloud
spec:
  containers:
  - args:
    - postgres
    image: docker.io/library/postgres:latest
    name: postgres
    env:
    - name: POSTGRES_USER
      value: "{{ nextcloud_database_user }}"
    - name: POSTGRES_PASSWORD
      value: "{{ nextcloud_database_user_password }}"
    - name: POSTGRES_DB
      value: "{{ nextcloud_database_name }}"
    securityContext:
      capabilities:
        drop:
        - CAP_MKNOD
        - CAP_NET_RAW
        - CAP_AUDIT_WRITE
    volumeMounts:
    - mountPath: /var/lib/postgresql/data/
      name: home-{{ user_name }}-postgres-host-0
  volumes:
  - hostPath:
      path: /home/{{ user_name }}/postgres
      type: Directory
    name: home-{{ user_name }}-postgres-host-0

  - args:
    - apache2-foreground
    image: docker.io/library/nextcloud:latest
    name: nextcloud
    env:
    - name: POSTGRES_DB
      value: "{{ nextcloud_database_name }}"
    - name: POSTGRES_USER
      value: "{{ nextcloud_database_user }}"
    - name: POSTGRES_PASSWORD
      value: "{{ nextcloud_database_user_password }}"
    - name: NEXTCLOUD_ADMIN_USER
      value: "{{ nextcloud_admin_user }}"
    - name: NEXTCLOUD_ADMIN_PASSWORD
      value: "{{ nextcloud_admin_password }}"
    - name: NEXTCLOUD_TRUSTED_DOMAINS
      value: "{{ nextcloud_trusted_domains }}"
    - name: POSTGRES_HOST
      value: "localhost"
    ports:
    - containerPort: 80
      hostPort: 10001
    securityContext:
      capabilities:
        drop:
        - CAP_MKNOD
        - CAP_NET_RAW
        - CAP_AUDIT_WRITE
    volumeMounts:
    - mountPath: /var/www/html/
      name: home-{{ user_name }}-nextcloud-base-host-0
    - mountPath: /var/www/html/data/
      name: home-{{ user_name }}-nextcloud-data-host-1
    - mountPath: /var/www/html/config/
      name: home-{{ user_name }}-nextcloud-config-host-2
    - mountPath: /var/www/html/custom_apps/
      name: home-{{ user_name }}-nextcloud-apps-host-3
  volumes:
  - hostPath:
      path: /home/{{ user_name }}/nextcloud/base
      type: Directory
    name: home-{{ user_name }}-nextcloud-base-host-0
  - hostPath:
    name: home-{{ user_name }}-nextcloud-base-host-0
  - hostPath:
      path: /home/{{ user_name }}/nextcloud/data
      type: Directory
    name: home-{{ user_name }}-nextcloud-data-host-1
  - hostPath:
      path: /home/{{ user_name }}/nextcloud/config
      type: Directory
    name: home-{{ user_name }}-nextcloud-config-host-2
  - hostPath:
      path: /home/{{ user_name }}/nextcloud/apps
      type: Directory
    name: home-{{ user_name }}-nextcloud-apps-host-3
