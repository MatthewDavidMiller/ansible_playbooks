# Credits
# https://www.decodingdevops.com/ansible-when-file-exists/
# https://techviewleo.com/list-of-ansible-os-family-distributions-facts/

---
- name: Install packages OpenWrt
  community.general.opkg:
    name: "{{ packages }}"
    state: present
    update_cache: yes
  when: ansible_facts['os_family'] == 'OpenWrt'

- name: Set the timezone
  community.general.timezone:
    name: US/Eastern
  when: ansible_facts['os_family'] == 'RedHat'

- name: Add a user
  ansible.builtin.user:
    name: "{{ user_name }}"
    groups: wheel
    append: "yes"
    password: "{{ user_name_password }}"
  when: (ansible_facts['os_family'] == 'RedHat') or (ansible_facts['os_family'] == 'OpenWrt')

- name: Set the root password
  ansible.builtin.user:
    name: root
    append: "yes"
    password: "{{ root_password }}"
  when: (ansible_facts['os_family'] == 'RedHat') or (ansible_facts['os_family'] == 'OpenWrt')

- name: Set default action for public to drop
  ansible.posix.firewalld:
    zone: public
    target: DROP
    permanent: yes
    state: present
  when: ansible_facts['os_family'] == 'RedHat'

- name: Create new zone and set it to drop
  ansible.posix.firewalld:
    zone: homelab
    target: DROP
    permanent: yes
    state: present
  when: ansible_facts['os_family'] == 'RedHat'

- name: Set ipv4 source for zone
  ansible.posix.firewalld:
    zone: homelab
    source: "{{ network_prefix }}"
    permanent: yes
    state: enabled
  when: ansible_facts['os_family'] == 'RedHat'

- name: Set ipv6 source for zone
  ansible.posix.firewalld:
    zone: homelab
    source: "fe80::/10"
    permanent: yes
    state: enabled
  when: ansible_facts['os_family'] == 'RedHat'

- name: Enable icmp block inversion
  ansible.posix.firewalld:
    zone: homelab
    icmp_block_inversion: yes
    permanent: yes
    state: enabled
  when: ansible_facts['os_family'] == 'RedHat'

- name: Allow SSH
  ansible.posix.firewalld:
    zone: homelab
    service: ssh
    permanent: yes
    state: enabled
  when: ansible_facts['os_family'] == 'RedHat'

- name: Allow icmp
  ansible.posix.firewalld:
    zone: homelab
    icmp_block: echo-request
    permanent: yes
    state: enabled
  when: ansible_facts['os_family'] == 'RedHat'

- name: Disable SSH in default zone
  ansible.posix.firewalld:
    zone: public
    service: ssh
    permanent: yes
    state: disabled
  when: ansible_facts['os_family'] == 'RedHat'

- name: Hosts file configuration
  ansible.builtin.template:
    src: hosts.j2
    dest: /etc/hosts
    owner: root
    group: root
    mode: "0644"
  when: ansible_facts['os_family'] == 'RedHat'

- name: Hostname file configuration
  ansible.builtin.template:
    src: hostname.j2
    dest: /etc/hostname
    owner: root
    group: root
    mode: "0644"
  when: ansible_facts['os_family'] == 'RedHat'

- name: locale configuration
  ansible.builtin.template:
    src: locale.j2
    dest: /etc/locale.conf
    owner: root
    group: root
    mode: "0644"
  when: ansible_facts['os_family'] == 'RedHat'

- name: SSH configuration
  ansible.builtin.template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: "0644"
  when: ansible_facts['os_family'] == 'RedHat'
